<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tower Defense</title>
  <link rel="icon" type="image/x-icon" href=data:image/png;base64,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>
<style>
    body {
      margin: 0;
      display: flex;
      font-family: sans-serif;
    }
    #game {
      background: #eee;
      width: 800px;
      height: 600px;
      display: block;
      border: 2px solid #000;
    }
    #shop {
      width: 280px;
      padding: 15px;
      background: #ccc;
      border-left: 2px solid #000;
      overflow-y: auto;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .tower-btn {
      display: block;
      padding: 10px;
      background: #444;
      color: #fff;
      text-align: center;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .tower-btn:hover:not(.locked) {
      background: #666;
    }
    .locked {
      background: #888;
      cursor: not-allowed;
    }
    #waveCountdown {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 32px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      display: none;
      z-index: 10;
    }
  </style>
</head>
<body>
<canvas id="game" width="800" height="600"></canvas>
<div id="shop">
  <h3>Shop</h3>
  <div class="tower-btn" onclick="selectTower('basic')">Basic Tower - $100</div>
  <div class="tower-btn" onclick="selectTower('strong')">Strong Tower - $200</div>
  <div class="tower-btn locked" id="vstrong-btn" onclick="selectTower('verystrong')">Very Strong Tower - $500</div>
  <hr>
  <p><strong>Money:</strong> $<span id="money">300</span></p>
  <p><strong>Level:</strong> <span id="level">1</span></p>
  <p><strong>Health:</strong> <span id="health">100</span></p>
  <p><strong>Status:</strong> <span id="status">Running</span></p>
  <small>Press [Space] to Pause/Resume</small>
  <hr>
  <h4>Upgrades</h4>
  <div class="tower-btn" onclick="upgradeFireRate()">Fire Rate +10% ($1500) <span id="fireRateLvl">(0/3)</span></div>
  <div class="tower-btn" onclick="upgradeDamage()">Damage +10% ($1500) <span id="damageLvl">(0/3)</span></div>
</div>

<div id="waveCountdown">Wave starting in 3...</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

let towers = [];
let enemies = [];
let bullets = [];
let money = 300;
let health = 100;
let level = 1;
let enemyHP = 50;
let enemySpawnRate = 2000;
let selectedTower = null;
let paused = false;
let lastTime = 0;
let enemiesToSpawn = 0;
let spawning = false;
let fireRateUpgrades = 0;
let damageUpgrades = 0;
let waveStarting = false;

let waypoints = [];

function generatePath() {
  waypoints = [];
  let x = 20;
  for (let i = 0; i < 6; i++) {
    x += Math.random() * 120 + 80;
    let y = Math.random() * 400 + 100;
    waypoints.push({ x: Math.min(x, canvas.width - 20), y });
  }
}

function upgradeFireRate() {
  if (fireRateUpgrades >= 3 || money < 1500) return;
  fireRateUpgrades++;
  money -= 1500;
  for (let t of towers) t.fireRate *= 0.9;
  updateUI();
}

function upgradeDamage() {
  if (damageUpgrades >= 3 || money < 1500) return;
  damageUpgrades++;
  money -= 1500;
  for (let t of towers) t.damage *= 1.1;
  updateUI();
}

const towerTypes = {
  basic: { cost: 100, range: 100, damage: 10, fireRate: 1000 },
  strong: { cost: 200, range: 150, damage: 25, fireRate: 1500 },
  verystrong: { cost: 500, range: 200, damage: 50, fireRate: 2000 }
};

function selectTower(type) {
  if (type === 'verystrong' && level < 10) return;
  selectedTower = type;
}

canvas.addEventListener('click', (e) => {
  if (!selectedTower) return;
  const tower = towerTypes[selectedTower];
  if (money >= tower.cost) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    towers.push({ ...tower, x, y, lastShot: 0 });
    money -= tower.cost;
    selectedTower = null;
    updateUI();
  }
});

function drawPath() {
  ctx.strokeStyle = 'black';
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(waypoints[0].x, waypoints[0].y);
  for (let wp of waypoints.slice(1)) {
    ctx.lineTo(wp.x, wp.y);
  }
  ctx.stroke();
}

function drawEnemies() {
  ctx.font = "12px sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "bottom";
  for (let e of enemies) {
    ctx.fillStyle = 'red';
    ctx.fillRect(e.x - 10, e.y - 10, 20, 20);
    ctx.fillStyle = 'black';
    ctx.fillText(`${e.hp}/${e.maxHp}`, e.x, e.y - 15);
  }
}

function drawTowers() {
  for (let t of towers) {
    ctx.beginPath();
    ctx.fillStyle = t.cost === 100 ? 'blue' : t.cost === 200 ? 'green' : 'red';
    ctx.arc(t.x, t.y, 10, 0, Math.PI * 2);
    ctx.fill();
  }
}

function drawBullets() {
  ctx.fillStyle = 'black';
  for (let b of bullets) {
    ctx.beginPath();
    ctx.arc(b.x, b.y, 4, 0, Math.PI * 2);
    ctx.fill();
  }
}

function updateEnemies() {
  for (let i = enemies.length - 1; i >= 0; i--) {
    const e = enemies[i];
    const target = waypoints[e.targetIndex];
    if (!target) {
      enemies.splice(i, 1);
      health -= 10;
      updateUI();
      continue;
    }

    const dx = target.x - e.x;
    const dy = target.y - e.y;
    const dist = Math.hypot(dx, dy);
    if (dist < 1) {
      e.targetIndex++;
    } else {
      const speed = 0.5 + level * 0.1;
      e.x += (dx / dist) * speed;
      e.y += (dy / dist) * speed;
    }
  }
}

function updateBullets(delta) {
  for (let i = bullets.length - 1; i >= 0; i--) {
    let b = bullets[i];
    if (!b.target || !enemies.includes(b.target)) {
      bullets.splice(i, 1);
      continue;
    }

    let dx = b.target.x - b.x;
    let dy = b.target.y - b.y;
    let dist = Math.hypot(dx, dy);
    if (dist < 5) {
      b.target.hp -= b.damage;
      if (b.target.hp <= 0) {
        enemies.splice(enemies.indexOf(b.target), 1);
        money += b.target.maxHp >= 150 ? 30 : 20;
        updateUI();
      }
      bullets.splice(i, 1);
      continue;
    }

    b.x += (dx / dist) * b.speed * delta;
    b.y += (dy / dist) * b.speed * delta;
  }
}

function shootBullets(time) {
  for (let t of towers) {
    if (time - t.lastShot > t.fireRate) {
      let target = enemies.find(e => Math.hypot(t.x - e.x, t.y - e.y) < t.range);
      if (target) {
        bullets.push({
          x: t.x,
          y: t.y,
          speed: 0.5,
          damage: t.damage,
          target: target
        });
        t.lastShot = time;
      }
    }
  }
}

function updateUI() {
  document.getElementById('money').innerText = money;
  document.getElementById('health').innerText = health;
  document.getElementById('level').innerText = level;
  document.getElementById('status').innerText = paused ? "Paused" : "Running";
  document.getElementById('fireRateLvl').innerText = `(${fireRateUpgrades}/3)`;
  document.getElementById('damageLvl').innerText = `(${damageUpgrades}/3)`;

  const vstrongBtn = document.getElementById('vstrong-btn');
  if (level >= 10) vstrongBtn.classList.remove('locked');
  else vstrongBtn.classList.add('locked');
}

function spawnEnemy() {
  enemies.push({
    x: waypoints[0].x,
    y: waypoints[0].y,
    hp: enemyHP,
    maxHp: enemyHP,
    targetIndex: 1
  });
  enemiesToSpawn--;
  if (enemiesToSpawn > 0) {
    setTimeout(spawnEnemy, Math.max(200, enemySpawnRate - level * 100));
  } else {
    spawning = false;
  }
}

function startWave() {
  if (spawning || enemies.length > 0 || waveStarting) return;

  waveStarting = true;
  let countdown = 3;
  const countdownEl = document.getElementById('waveCountdown');
  countdownEl.style.display = 'block';
  countdownEl.innerText = `Wave ${level} starting in ${countdown}...`;

  const countdownInterval = setInterval(() => {
    countdown--;
    if (countdown > 0) {
      countdownEl.innerText = `Wave ${level} starting in ${countdown}...`;
    } else {
      clearInterval(countdownInterval);
      countdownEl.style.display = 'none';

      enemiesToSpawn = 5 + level * 2;
      spawning = true;
      spawnEnemy();
      enemyHP += 10;
      level++;
      waveStarting = false;
      updateUI();
    }
  }, 1000);
}

function gameLoop(time) {
  requestAnimationFrame(gameLoop);
  if (paused) return;

  let delta = time - lastTime;
  delta = Math.min(delta, 100); // Prevent massive jumps after pause/tab switch
  lastTime = time;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawPath();
  drawEnemies();
  drawTowers();
  drawBullets();
  updateEnemies();
  updateBullets(delta);
  shootBullets(time);

  if (health <= 0) {
    paused = true;
    setTimeout(() => {
      alert("Game Over!");
      window.location.reload();
    }, 100);
    return;
  }

  if (enemies.length === 0 && !spawning && !waveStarting) startWave();
}


updateUI();
generatePath();
gameLoop(0);
startWave();
</script>

</body>
</html>
